# Sub-Phase 9.0: System Architecture & Planning

**Status:** ✅ COMPLETE
**Priority:** CRITICAL
**Timeline:** 1-2 weeks (Completed in 1 day)
**Dependencies:** None
**Started:** October 11, 2025
**Completed:** October 11, 2025

---

## ✅ Completion Summary

**Completed October 11, 2025** - All architecture components implemented and tested:

1. **Database Schema** ✅
   - `sql/phase9_box_score_snapshots.sql` (510 lines)
   - 4 tables: `game_state_snapshots`, `player_snapshot_stats`, `quarter_box_scores`, `box_score_verification`
   - 2 views: `latest_snapshots`, `verification_summary`
   - Comprehensive indexing for temporal queries
   - Support for 22M snapshots across 44,826 games

2. **Data Structures** ✅
   - `scripts/pbp_to_boxscore/box_score_snapshot.py` (360 lines)
   - `PlayerStats`: Immutable player stats at each event (23 fields)
   - `TeamStats`: Immutable team aggregations
   - `BoxScoreSnapshot`: Complete game state snapshot
   - `VerificationResult`: Quality grading system (A-F)
   - Full validation methods

3. **Base Processor Class** ✅
   - `scripts/pbp_to_boxscore/base_processor.py` (514 lines)
   - Abstract class for all PBP processors
   - Shared logic: `process_game()`, `verify_final_box_score()`
   - Event-by-event box score updates
   - Substitution and on-court player tracking
   - Comprehensive error handling

4. **Test Framework** ✅
   - `tests/test_pbp_to_boxscore/test_espn_processor.py`
   - All data structure tests passing
   - Validation logic verified
   - Ready for live game testing

**Total Code:** 1,384 lines across 4 files
**Tests:** All passing ✅
**Next:** Phase 9.1 (ESPN Processor)

---

## Objective

Design unified interface for multiple PBP sources, define box score snapshot data structure, create verification framework, and establish quarter-by-quarter tracking.

---

## Deliverables

1. **Box Score Snapshot Schema**
   - Data structure for immutable snapshots
   - Player stats tracking
   - Team stats aggregation
   - Quarter boundaries

2. **Data Source Abstraction Layer**
   - Base processor class
   - Common interfaces
   - Error handling patterns
   - Retry logic

3. **Verification Methodology**
   - Comparison algorithms
   - Discrepancy calculation
   - Quality grading (A-F)
   - Acceptance thresholds

4. **Performance Benchmarks**
   - Processing speed targets
   - Accuracy goals by era
   - Storage efficiency
   - Query response times

---

## Database Schema

### game_state_snapshots
```sql
CREATE TABLE game_state_snapshots (
    snapshot_id BIGSERIAL PRIMARY KEY,
    game_id VARCHAR(50) NOT NULL,
    event_num INTEGER NOT NULL,
    quarter INTEGER NOT NULL,
    time_remaining VARCHAR(10),
    game_clock_seconds INTEGER,
    data_source VARCHAR(50) NOT NULL,
    verification_passed BOOLEAN,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(game_id, event_num, data_source)
);
```

### player_snapshot_stats
```sql
CREATE TABLE player_snapshot_stats (
    snapshot_id BIGINT REFERENCES game_state_snapshots(snapshot_id),
    player_id VARCHAR(50) NOT NULL,
    team_id VARCHAR(10) NOT NULL,
    points INTEGER DEFAULT 0,
    fgm INTEGER DEFAULT 0,
    fga INTEGER DEFAULT 0,
    fg3m INTEGER DEFAULT 0,
    fg3a INTEGER DEFAULT 0,
    ftm INTEGER DEFAULT 0,
    fta INTEGER DEFAULT 0,
    oreb INTEGER DEFAULT 0,
    dreb INTEGER DEFAULT 0,
    reb INTEGER DEFAULT 0,
    ast INTEGER DEFAULT 0,
    stl INTEGER DEFAULT 0,
    blk INTEGER DEFAULT 0,
    tov INTEGER DEFAULT 0,
    pf INTEGER DEFAULT 0,
    plus_minus INTEGER DEFAULT 0,
    minutes DECIMAL(5,2) DEFAULT 0,
    on_court BOOLEAN DEFAULT false,
    PRIMARY KEY(snapshot_id, player_id)
);
```

### quarter_box_scores
```sql
CREATE TABLE quarter_box_scores (
    game_id VARCHAR(50) NOT NULL,
    quarter INTEGER NOT NULL,
    player_id VARCHAR(50) NOT NULL,
    team_id VARCHAR(10) NOT NULL,
    points INTEGER DEFAULT 0,
    fgm INTEGER DEFAULT 0,
    fga INTEGER DEFAULT 0,
    fg3m INTEGER DEFAULT 0,
    fg3a INTEGER DEFAULT 0,
    ftm INTEGER DEFAULT 0,
    fta INTEGER DEFAULT 0,
    oreb INTEGER DEFAULT 0,
    dreb INTEGER DEFAULT 0,
    reb INTEGER DEFAULT 0,
    ast INTEGER DEFAULT 0,
    stl INTEGER DEFAULT 0,
    blk INTEGER DEFAULT 0,
    tov INTEGER DEFAULT 0,
    pf INTEGER DEFAULT 0,
    minutes DECIMAL(5,2) DEFAULT 0,
    data_source VARCHAR(50) NOT NULL,
    PRIMARY KEY(game_id, quarter, player_id, data_source)
);
```

### box_score_verification
```sql
CREATE TABLE box_score_verification (
    game_id VARCHAR(50) PRIMARY KEY,
    data_source VARCHAR(50) NOT NULL,
    final_score_match BOOLEAN,
    total_discrepancies INTEGER DEFAULT 0,
    discrepancy_details JSONB,
    mae_points DECIMAL(5,2),
    mae_rebounds DECIMAL(5,2),
    mae_assists DECIMAL(5,2),
    quality_grade CHAR(1),
    verified_at TIMESTAMP DEFAULT NOW()
);
```

---

## Code Structure

```
scripts/pbp_to_boxscore/
├── __init__.py
├── base_processor.py          # Abstract base class
├── box_score_snapshot.py      # Snapshot data structure
├── espn_processor.py          # ESPN PBP → Box Score
├── hoopr_processor.py         # hoopR PBP → Box Score
├── nba_api_processor.py       # NBA API PBP → Box Score
├── kaggle_processor.py        # Kaggle PBP → Box Score
├── verification.py            # Verify vs. actual box scores
├── quarter_tracker.py         # Quarter-by-quarter logic
├── storage_manager.py         # Save to RDS/S3/local
└── batch_processor.py         # Parallel processing

scripts/advanced_metrics/
├── __init__.py
├── efficiency.py              # TS%, eFG%, PER, etc.
├── advanced_stats.py          # ORtg, DRtg, Pace, etc.
├── context_stats.py           # Win prob, EPA, clutch
└── situational.py             # Quarter, home/away, rest

scripts/ml_features/
├── __init__.py
├── temporal_features.py       # Rolling stats, momentum
├── quarter_features.py        # Quarter-specific features
└── lineup_features.py         # Player combination features
```

---

## Base Processor Interface

```python
from abc import ABC, abstractmethod
from typing import Dict, List, Any
from dataclasses import dataclass

@dataclass
class BoxScoreSnapshot:
    """Snapshot of box score at a specific moment"""
    game_id: str
    event_num: int
    quarter: int
    time_remaining: str
    game_clock_seconds: int
    players: Dict[str, Dict[str, Any]]
    team_stats: Dict[str, Dict[str, Any]]
    quarter_box_scores: Dict[str, Dict[str, Any]]

class BasePlayByPlayProcessor(ABC):
    """Abstract base class for PBP processors"""

    @abstractmethod
    def load_game_data(self, game_id: str) -> Any:
        """Load raw PBP data for a game"""
        pass

    @abstractmethod
    def parse_event(self, event: Any) -> Dict:
        """Parse a single PBP event"""
        pass

    @abstractmethod
    def update_box_score(self, box_score: Dict, event: Dict) -> Dict:
        """Update box score with new event"""
        pass

    def process_game(self, game_id: str) -> List[BoxScoreSnapshot]:
        """Process entire game, return list of snapshots"""
        # Common logic here
        pass

    def verify_final_box_score(self, generated: Dict, actual: Dict) -> Dict:
        """Verify generated box score matches actual"""
        # Common verification logic
        pass
```

---

## Verification Criteria

### Tier 1: Critical (Must Pass)
- Final score matches actual: 100%
- Total points per player: ±1 point
- No negative stats
- Minutes played ≤ game duration
- All players accounted for

### Tier 2: High-Priority (Should Pass)
- Rebounds: ±2
- Assists: ±2
- FG attempts ≥ FGM
- Team totals = sum of player stats

### Tier 3: Nice-to-Have
- Plus/minus accuracy
- Substitution patterns realistic
- Foul accumulation logical

### Quality Grading
- **Grade A**: All Tier 1 + Tier 2 passed, <2 total discrepancies
- **Grade B**: All Tier 1 passed, 2-5 Tier 2 issues
- **Grade C**: Tier 1 passed, 6-15 Tier 2 issues
- **Grade F**: Any Tier 1 failures

---

## Performance Targets

| Metric | Target | Stretch | Maximum |
|--------|--------|---------|---------|
| Processing Speed | 500ms/game | 250ms/game | 2s/game |
| Accuracy (2023-25) | 99.9% | 100% | 99% minimum |
| Accuracy (2010-22) | 99.5% | 99.9% | 98% minimum |
| Accuracy (2000-09) | 98% | 99% | 95% minimum |
| Accuracy (1995-99) | 95% | 98% | 90% minimum |
| Storage Compression | 10:1 | 15:1 | 5:1 minimum |
| Query Response | <100ms | <50ms | <500ms |

---

## Testing Strategy

### Unit Tests
1. Box score snapshot creation
2. Event parsing logic
3. Stat accumulation
4. Quarter tracking
5. Verification algorithms

### Integration Tests
1. Full game processing
2. Multi-source comparison
3. Storage operations
4. Batch processing

### Validation Tests
1. Sample of known-good games
2. Cross-source validation
3. Historical consistency
4. Edge cases (OT, short games, blowouts)

---

## Success Criteria

- ✅ Database tables created in RDS
- ✅ Base processor class implemented
- ✅ Box score snapshot structure defined
- ✅ Verification framework operational
- ✅ Unit tests passing
- ✅ Documentation complete

---

## Next Steps

After 9.0 complete:
1. Update PHASE_9_INDEX.md status
2. Move to 9.1 (ESPN processor)
3. Implement first concrete processor
4. Test with sample games

---

## References

- **Complete Plan**: `~/Downloads/pbp_to_boxscore_plan.md` - Section 8.0
- **Code Structure**: `~/Downloads/claude_code_instructions.md`
- **Database Design**: SQL schemas above

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-10-11 | 1.0 | Initial sub-phase created | Claude |

---

**Status:** Ready to begin
**Next Action:** Create database tables, implement base classes, write tests

