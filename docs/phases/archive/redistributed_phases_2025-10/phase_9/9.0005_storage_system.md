# Sub-Phase 9.0005: Unified Box Score Storage System

**Status:** ⏸️ PENDING
**Priority:** HIGH
**Timeline:** 1 week
**Dependencies:** 9.1 (need data to store)
**Started:** Not started
**Completed:** Not completed

---

## Objective

Implement efficient storage for generated box score snapshots with fast temporal query capability.

---

## Storage Strategy

**1. RDS PostgreSQL** (for queries)
- `game_state_snapshots` table
- `player_snapshot_stats` table
- `quarter_box_scores` table
- `box_score_verification` table

**2. S3 Parquet** (for ML training)
- Path: `s3://nba-sim-raw-data-lake/box_score_snapshots/`
- Partitioned by: season, month, game_id
- Format: Parquet with Snappy compression

**3. Local SQLite** (for development)
- Recent games cached locally
- Fast iteration during development

---

## Compression Targets

- Parquet compression ratio: 10:1 minimum
- Expected storage: ~5 GB for all games
- Query response: <100ms for single game

---

## Implementation

```python
class StorageManager:
    def save_snapshot_to_rds(self, snapshot: BoxScoreSnapshot) -> int:
        """Save snapshot to PostgreSQL"""
        pass

    def save_snapshots_to_parquet(self, snapshots: List[BoxScoreSnapshot], path: str):
        """Save to S3 Parquet for ML training"""
        pass

    def cache_locally(self, game_id: str, snapshots: List[BoxScoreSnapshot]):
        """Cache in local SQLite"""
        pass
```

---

## Success Criteria

- ✅ All snapshots stored in RDS
- ✅ Parquet files uploaded to S3
- ✅ Query response <100ms
- ✅ Compression ratio >10:1

---

## References

- **Complete Plan**: `~/Downloads/pbp_to_boxscore_plan.md` - Section 8.5

---

**Status:** Ready after 9.1 generates data











---

## How This Phase Enables the Simulation Vision

This phase provides critical infrastructure that powers the **hybrid econometric + nonparametric simulation system** described in the [main README](../../../README.md#simulation-methodology).

**What this phase enables:**

### 1. Econometric Causal Inference Foundation

Database infrastructure enables efficient econometric analysis:

**Panel data storage:**
- **Indexed time series:** Fast retrieval for fixed effects, random effects models
- **Player-season observations:** Enables within-player variation analysis
- **Team-game structure:** Supports difference-in-differences estimation

**Query optimization for causal inference:**
- **Instrumental variables:** Efficient joins for IV regression data preparation
- **Propensity score matching:** Fast similarity searches across observational units
- **Synthetic control:** Rapid donor pool selection for counterfactual construction

**Estimation infrastructure:**
- Clustered standard errors: Group-level aggregation for within-cluster correlation
- Bootstrap resampling: Efficient random sampling for uncertainty quantification
- Cross-validation: Partitioned data access for out-of-sample testing

### 2. Nonparametric Event Modeling (Distribution-Free)

Database queries enable efficient nonparametric estimation:

**Empirical distribution queries:**
- **Fast sampling:** Rapid random draws from large empirical datasets
- **Stratified sampling:** Conditional distributions by game context (playoff vs regular season)
- **Temporal queries:** Historical empirical distributions at specific time points

**Kernel density estimation:**
- **Bandwidth selection:** Efficient cross-validation for optimal smoothing
- **Local density computation:** Fast nearest-neighbor searches for KDE
- **Multivariate densities:** Joint empirical distributions across multiple variables

**Bootstrap infrastructure:**
- **Resampling efficiency:** Fast random sampling with replacement
- **Parallel bootstrap:** Distributed bootstrap replications
- **Block bootstrap:** Time series bootstrap preserving temporal dependence

### 3. Context-Adaptive Simulations

Using database queries, simulations adapt in real-time:

**Dynamic parameter retrieval:**
- Queries player fatigue levels for current minute load
- Fetches recent performance trends (last 5 games)
- Retrieves matchup-specific data (defender vs. offensive player history)

**Context-specific estimation:**
- Pulls playoff vs. regular season coefficients
- Queries home vs. away performance differentials
- Retrieves clutch vs. non-clutch performance data

**Temporal adaptation:**
- Historical queries at exact game time for realistic context
- Dynamic updates based on game flow
- Real-time incorporation of lineup changes

### 4. Integration with Main README Methodology

**Panel data regression (Main README: Lines 81-87):**
- Database schema optimized for panel data retrieval (indexed by player, season, game)

**Nonparametric validation (Main README: Line 116):**
- Database queries enable efficient K-S tests for distribution-free validation

**Monte Carlo simulation (Main README: Line 119):**
- Database enables fast parameter retrieval for 10,000+ Monte Carlo simulation runs

**See [main README](../../../README.md) for complete methodology.**

---
