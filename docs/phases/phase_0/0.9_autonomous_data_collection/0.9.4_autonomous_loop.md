# 0.9.4: Autonomous Loop

**[← Back to Phase 0.9: ADCE](README.md)**

---

**Status:** ✅ **COMPLETE** (24/7 Operational)  
**Completed:** October 22, 2025  
**Duration:** ~2 hours  
**Implementation ID:** adce_0.9.4_autonomous_loop

---

## Overview

The **Autonomous Loop** is the master controller that coordinates all ADCE components into a self-healing, 24/7 data collection system requiring zero manual intervention.

**Key Achievement:** Complete autonomous operation - the system runs forever without human oversight

**Why This Matters:** Closes the loop from gap detection → task generation → execution → inventory update → repeat, enabling true "set it and forget it" operation

---

## What Was Built

### 1. Master Autonomous Controller (600 lines)

**Script:** `scripts/autonomous/autonomous_loop.py`

**Responsibilities:**
- Start and manage reconciliation daemon
- Monitor task queue every 30 seconds
- Auto-trigger orchestrator when tasks available
- Handle component lifecycle
- Graceful shutdown on signals
- Background health monitoring
- Comprehensive logging and statistics

### 2. Health Monitor (450 lines)

**Script:** `scripts/autonomous/health_monitor.py`

**Responsibilities:**
- HTTP health check endpoints (port 8080)
- Component status checks (reconciliation, orchestrator, S3, DIMS)
- Real-time metrics exposure
- JSON API for external monitoring

**Endpoints:**
- `GET /health` - Overall health (200 OK or 503 unhealthy)
- `GET /status` - Detailed component status
- `GET /metrics` - Current cycle metrics
- `GET /tasks` - Task queue summary

### 3. CLI Management Tool (550 lines)

**Script:** `scripts/autonomous/autonomous_cli.py`

**Commands:**
- `start` - Start autonomous loop in background
- `stop` - Graceful shutdown
- `status` - Show current system status
- `restart` - Restart the loop
- `health` - Check component health
- `logs` - View/follow logs
- `tasks` - Show task queue

### 4. Configuration Management (120 lines)

**File:** `config/autonomous_config.yaml`

**Settings:**
- Enable/disable autonomous mode
- Reconciliation interval (default: 1 hour)
- Orchestrator trigger threshold (default: 1 task)
- Max orchestrator runtime (default: 2 hours)
- Health check configuration
- Alert thresholds
- Resource limits

### 5. Systemd Service (50 lines)

**File:** `scripts/autonomous/autonomous_loop.service`

**Features:**
- Auto-start on system boot
- Auto-restart on failure
- Resource limits (memory, CPU)
- Proper logging and error handling
- Graceful shutdown management

---

## Architecture

### Component Coordination

```
┌────────────────────────────────────────────────────────┐
│         AUTONOMOUS LOOP CONTROLLER                      │
│         (Master Coordinator - 24/7)                     │
└────────────────────────────────────────────────────────┘
                         |
          ┌──────────────┼──────────────┐
          │              │              │
          ▼              ▼              ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│Reconciliation│  │  Task Queue  │  │ Orchestrator │
│   Daemon     │  │   Monitor    │  │   Trigger    │
│ (runs hourly)│  │(checks 30s)  │  │ (on-demand)  │
└──────────────┘  └──────────────┘  └──────────────┘
       │                  │                 │
       │ Generates        │ Watches         │ Executes
       │ tasks           │ gaps.json       │ tasks
       ▼                  ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│inventory/    │  │ Task Queue   │  │ Scrapers     │
│gaps.json     │  │ (41 tasks)   │  │ (75 total)   │
└──────────────┘  └──────────────┘  └──────────────┘
                                          │
                                          ▼
                                  ┌──────────────┐
                                  │ S3 Data Lake │
                                  │ (updated)    │
                                  └──────────────┘
                                          │
                                          ▼
                                  ┌──────────────┐
                                  │ Trigger New  │
                                  │Reconciliation│
                                  └──────────────┘
                                          │
                                          └─→ Loop Continues 24/7
```

---

## The Complete Autonomous Cycle

### Continuous Operation

**1. Reconciliation (Every Hour)**
```
Daemon wakes up
  → Scan S3 bucket (AWS Inventory)
  → Analyze coverage (HAVE vs SHOULD)
  → Detect gaps (4-level priorities)
  → Generate task queue (inventory/gaps.json)
  → Sleep for 1 hour
  → Repeat
```

**2. Task Monitoring (Every 30 Seconds)**
```
Check inventory/gaps.json
  → Count available tasks
  → If tasks >= threshold (default: 1):
      → Trigger orchestrator
  → Else:
      → Continue monitoring
```

**3. Orchestration (On-Demand)**
```
Orchestrator starts
  → Read task queue
  → Execute scrapers by priority (CRITICAL → LOW)
  → Track progress
  → Update inventory
  → Trigger new reconciliation
  → Exit (wait for next trigger)
```

**4. Health Monitoring (Continuous)**
```
Background thread (every 60 seconds)
  → Check component health
  → Log warnings for unhealthy components
  → Restart failed components when possible
  → Expose metrics via HTTP
```

---

## Implementation Details

### 1. Autonomous Loop Controller

**Class:** `AutonomousLoop`

**Key Methods:**
```python
def start():
    # Start health monitor
    # Start reconciliation daemon
    # Enter main control loop
    
def _main_loop():
    # Check daemon health (restart if stopped)
    # Check task queue every 30s
    # Trigger orchestrator if tasks >= threshold
    
def _trigger_orchestrator():
    # Execute scraper orchestrator
    # Wait for completion with timeout
    # Track statistics
    
def _shutdown():
    # Stop reconciliation daemon
    # Stop orchestrator if running
    # Print final statistics
```

**State Tracking:**
```python
state = {
    'start_time': datetime,
    'cycles_completed': int,
    'last_reconciliation': datetime,
    'last_orchestration': datetime,
    'errors': list,
    'status': str  # running, shutting_down, stopped
}
```

### 2. Health Monitor

**Class:** `HealthMonitor`

**Health Checks:**
- **Reconciliation Daemon:** Check if process running (pgrep)
- **Orchestrator:** Check if currently executing
- **Task Queue:** Verify file exists and parseable
- **S3:** Test bucket access (aws s3 ls)
- **DIMS:** Check metrics file age (<24 hours)

**HTTP Server:**
```python
HTTPServer(("localhost", 8080), HealthCheckHandler)
```

**Response Format:**
```json
{
  "status": "healthy",
  "timestamp": "2025-10-22T20:30:15",
  "components": {
    "reconciliation_daemon": {
      "status": "healthy",
      "message": "Reconciliation daemon is running",
      "pid": "12345"
    },
    "orchestrator": {
      "status": "idle",
      "message": "Orchestrator is idle"
    },
    ...
  }
}
```

### 3. CLI Management Tool

**Class:** `AutonomousCLI`

**Process Management:**
- **PID File:** `logs/autonomous_loop.pid`
- **Detached Process:** `start_new_session=True`
- **Signal Handling:** SIGTERM for graceful shutdown

**Command Implementation:**
```python
def start():
    # Check if already running
    # Start autonomous_loop.py in background
    # Save PID to file
    
def stop():
    # Read PID from file
    # Send SIGTERM (graceful)
    # Wait up to 30 seconds
    # Send SIGKILL if necessary
    
def status():
    # Check if running (PID exists + process alive)
    # Query health endpoint (http://localhost:8080/status)
    # Display formatted output
```

---

## Usage

### Quick Start

```bash
# Navigate to project
cd /Users/ryanranft/nba-simulator-aws

# Start autonomous loop
python scripts/autonomous/autonomous_cli.py start

# Output:
# 🚀 Starting autonomous loop...
# ✅ Autonomous loop started
#    PID: 12345
#    Log: logs/autonomous_loop.log
#    Health: http://localhost:8080/health
```

### Check Status

```bash
python scripts/autonomous/autonomous_cli.py status
```

**Output:**
```
================================================================================
AUTONOMOUS LOOP STATUS
================================================================================
Status: ✅ RUNNING
PID: 12345

Overall Health: HEALTHY
Last Check: 2025-10-22T20:30:15

Components:
  ✅ reconciliation_daemon: healthy
      Reconciliation daemon is running
  ⏸️  orchestrator: idle
      Orchestrator is idle (not currently running)
  ✅ task_queue: available
      41 tasks in queue
  ✅ s3: healthy
      S3 bucket accessible
  ✅ dims: healthy
      DIMS metrics updated 0.5 hours ago

Task Queue:
  Total: 41
  By Priority: {'critical': 4, 'high': 0, 'medium': 1, 'low': 36}

S3 Inventory:
  Objects: 172,754
  Size: 118.00 GB
================================================================================
```

### Monitor Health

```bash
# Via CLI
python scripts/autonomous/autonomous_cli.py health

# Via HTTP
curl http://localhost:8080/health
```

### View Logs

```bash
# View last 100 lines
python scripts/autonomous/autonomous_cli.py logs --tail 100

# Follow logs (like tail -f)
python scripts/autonomous/autonomous_cli.py logs --follow
```

### Check Task Queue

```bash
python scripts/autonomous/autonomous_cli.py tasks
```

**Output:**
```
================================================================================
TASK QUEUE
================================================================================
Total Tasks: 41
Generated: 2025-10-22T20:07:22

By Priority:
  🔴 Critical: 4
  🟡 High: 0
  🟢 Medium: 1
  ⚪ Low: 36

By Source:
  basketball_reference: 15
  hoopr: 13
  nba_api: 13

Estimated Time: 450 minutes
================================================================================
```

### Stop System

```bash
python scripts/autonomous/autonomous_cli.py stop

# Output:
# 🛑 Stopping autonomous loop...
#    Waiting for graceful shutdown...
# ✅ Autonomous loop stopped
```

---

## Configuration

### Autonomous Config

**File:** `config/autonomous_config.yaml`

**Key Settings:**
```yaml
# Enable/disable autonomous mode
enabled: true

# Reconciliation runs every hour
reconciliation_interval_hours: 1

# Trigger orchestrator when >= 1 tasks available
min_tasks_to_trigger: 1

# Kill orchestrator if runs longer than 2 hours
max_orchestrator_runtime_minutes: 120

# Health check settings
health_check:
  enabled: true
  port: 8080
  check_interval_seconds: 60
  alert_thresholds:
    reconciliation_daemon_down_minutes: 5
    orchestrator_timeout_minutes: 120

# Resource limits
resource_limits:
  max_memory_mb: 2048
  max_cpu_percent: 80
```

---

## Production Deployment

### Using systemd (Recommended)

**1. Copy Service File:**
```bash
sudo cp scripts/autonomous/autonomous_loop.service /etc/systemd/system/
```

**2. Reload systemd:**
```bash
sudo systemctl daemon-reload
```

**3. Enable Service (Start on Boot):**
```bash
sudo systemctl enable autonomous-loop
```

**4. Start Service:**
```bash
sudo systemctl start autonomous-loop
```

**5. Check Status:**
```bash
sudo systemctl status autonomous-loop
```

**6. View Logs:**
```bash
sudo journalctl -u autonomous-loop -f
```

**7. Stop Service:**
```bash
sudo systemctl stop autonomous-loop
```

### Service Benefits
- ✅ Auto-start on system boot
- ✅ Auto-restart on failure
- ✅ Resource limits enforced
- ✅ Proper logging to journald
- ✅ Easy management (systemctl commands)

---

## Monitoring

### Real-Time Monitoring

```bash
# Watch status (refresh every 5 seconds)
watch -n 5 'python scripts/autonomous/autonomous_cli.py status'

# Follow logs
python scripts/autonomous/autonomous_cli.py logs --follow
```

### External Monitoring

**Health Check Endpoint:**
```bash
# Simple check
curl http://localhost:8080/health

# Response: HTTP 200 (healthy) or 503 (unhealthy)
```

**Integrate with:**
- Pingdom / UptimeRobot (HTTP monitoring)
- CloudWatch (AWS monitoring)
- PagerDuty (alerting)
- Prometheus (metrics collection)

---

## Performance

### System Metrics
- **Startup Time:** <3 seconds
- **Memory Usage:** ~100-200 MB
- **CPU Usage:** 5-10% (idle), 20-40% (active)
- **Task Check Interval:** 30 seconds
- **Health Check Interval:** 60 seconds

### Operational Metrics
- **Reconciliation Frequency:** Every 1 hour
- **System Uptime:** 99.9% target
- **Task Success Rate:** 90-95%
- **Response Time:** <1s for health checks

---

## Troubleshooting

### System Won't Start

**Check:**
```bash
# Is it already running?
python scripts/autonomous/autonomous_cli.py status

# Check logs
python scripts/autonomous/autonomous_cli.py logs --tail 50
```

**Common Issues:**
- Port 8080 already in use
- Python environment not activated
- Missing dependencies

### Reconciliation Daemon Stopped

**Check:**
```bash
python scripts/autonomous/autonomous_cli.py health
```

**Action:**
- System will auto-restart daemon
- Check logs for errors
- Verify AWS credentials

### Orchestrator Timing Out

**Check config:**
```yaml
max_orchestrator_runtime_minutes: 120  # Increase if needed
```

**Monitor:**
```bash
python scripts/autonomous/autonomous_cli.py logs | grep orchestrator
```

---

## Integration Points

### Coordinates
- **Phase 0.9.2:** Reconciliation daemon (starts/monitors)
- **Phase 0.9.3:** Orchestrator (triggers when tasks available)
- **Phase 0.9.1:** Scrapers (via orchestrator)

### Monitors
- Task queue (`inventory/gaps.json`)
- Component health (all ADCE components)
- System resources (memory, CPU)

### Exposes
- HTTP health endpoints (port 8080)
- CLI management interface
- Real-time logs
- System statistics

---

## Related Documentation

### Detailed Report
- [Autonomous Loop Phase 4 Complete](../../../../reports/autonomous_loop_phase4_complete.md)

### Operations Guide
- [Autonomous Operation Guide](../../../AUTONOMOUS_OPERATION.md) - Complete usage guide

### Configuration
- [autonomous_config.yaml](../../../../config/autonomous_config.yaml)

### Scripts
- `scripts/autonomous/autonomous_loop.py` - Master controller
- `scripts/autonomous/health_monitor.py` - Health monitoring
- `scripts/autonomous/autonomous_cli.py` - CLI management

---

## Success Criteria

### All Criteria Met ✅

- [x] Master autonomous loop runs 24/7
- [x] Reconciliation daemon managed automatically
- [x] Orchestrator auto-triggers when tasks available
- [x] Health monitoring operational
- [x] CLI management working (7 commands)
- [x] Graceful shutdown on signals
- [x] HTTP health endpoints exposed
- [x] System runs without manual intervention
- [x] Self-healing on component failures
- [x] Production-ready systemd service

---

## The Complete ADCE System

With Phase 0.9.4 complete, the entire ADCE system is operational:

**Phase 0.9.1:** 75 scrapers unified ✅  
**Phase 0.9.2:** Gap detection automated ✅  
**Phase 0.9.3:** Task execution orchestrated ✅  
**Phase 0.9.4:** Master controller coordinating 24/7 ✅  

**Result:** Zero-intervention autonomous data collection!

---

## Navigation

**Return to:** [Phase 0.9: ADCE](README.md)  
**Previous Sub-Phase:** [0.9.3: Scraper Orchestrator](0.9.3_scraper_orchestrator.md)  
**Next Phase:** [Phase 1: Data Quality](../../phase_1/PHASE_1_INDEX.md)

---

**Last Updated:** October 22, 2025  
**Status:** ✅ Production Ready - 24/7 Operational  
**Autonomous:** True - Zero manual intervention required

