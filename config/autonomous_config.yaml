# Autonomous Loop Configuration
# ADCE Phase 4 - 24/7 Self-Healing System

version: "1.0"
last_updated: "2025-10-22"

# Enable/Disable Autonomous Mode
enabled: true

# Test Mode Configuration (for component testing without reconciliation)
test_mode:
  enabled: false # Enable for component testing
  skip_reconciliation: true # Don't start reconciliation daemon in test mode
  skip_task_queue_check: false # Still process tasks if queue exists
  clear_queue_on_start: false # Don't clear existing queue on startup
  allow_execution: true # Allow scraper execution (unlike dry_run)
  # Note: test_mode allows execution but skips reconciliation
  #       dry_run prevents all execution

# Reconciliation Configuration
# Week 3 Enhancement: Real-Time Reconciliation (15-min cycles instead of 1 hour)
reconciliation_interval_minutes: 15 # Run reconciliation every 15 minutes (4x faster gap detection)
use_aws_inventory: true # Use AWS S3 Inventory when available
fallback_to_sample: true # Fall back to sampling if inventory unavailable

# Legacy support (deprecated, use reconciliation_interval_minutes)
# reconciliation_interval_hours: 1

# Orchestrator Configuration
min_tasks_to_trigger: 1 # Minimum tasks in queue to trigger orchestrator
max_orchestrator_runtime_minutes: 60 # Kill orchestrator if runs longer than 1 hour
max_concurrent_scrapers: 5 # Maximum concurrent scraper processes

# Rate Limiting Configuration (Week 3 Enhancement)
rate_limiting:
  enabled: true # Enable global rate limit coordination

  # Global rate limits (across all scrapers)
  global_limits:
    requests_per_minute: 100 # Max total requests/min across all scrapers
    requests_per_hour: 5000 # Max total requests/hour across all scrapers

  # Per-source rate limits
  source_limits:
    espn:
      requests_per_minute: 60 # ESPN allows higher rate
      requests_per_hour: 3000
      burst_size: 10 # Allow bursts of 10 requests

    nba_api:
      requests_per_minute: 30 # NBA API more restrictive
      requests_per_hour: 1000
      burst_size: 5

    basketball_reference:
      requests_per_minute: 20 # Be gentle with Basketball Reference
      requests_per_hour: 500
      burst_size: 3
      min_delay_seconds: 3 # Minimum 3s between requests

    hoopr:
      requests_per_minute: 40
      requests_per_hour: 2000
      burst_size: 8

  # Backoff strategy when limits approached
  backoff:
    enabled: true
    threshold_percent: 80 # Start backing off at 80% of limit
    initial_delay_seconds: 1 # Start with 1s delay
    max_delay_seconds: 30 # Cap at 30s delay
    exponential_factor: 2 # Double delay each time

# Task Queue Configuration
task_queue_file: inventory/gaps.json
task_processing:
  priority_order: # Execute tasks in this order
    - CRITICAL
    - HIGH
    - MEDIUM
    - LOW
  max_tasks_per_run: 1000 # Limit tasks per orchestrator run

  # Weighted Priority Scoring (Week 3 Enhancement)
  priority_weighting:
    enabled: true # Use weighted scoring instead of simple priority groups

    # Base priority scores
    base_scores:
      CRITICAL: 1000
      HIGH: 100
      MEDIUM: 10
      LOW: 1

    # Age factor: points added per hour old
    age_weight: 0.5 # Add 0.5 points per hour since detection

    # Source importance multipliers
    source_multipliers:
      espn: 1.5 # ESPN is most reliable
      nba_api: 1.3
      basketball_reference: 1.2
      hoopr: 1.1
      default: 1.0

    # Gap size factor: smaller gaps = higher priority
    gap_size_weight: -0.1 # Subtract 0.1 points per missing file
    max_gap_size_penalty: 10 # Cap penalty at 10 points

    # Historical success rate boost
    success_rate_weight: 20 # Add up to 20 points for 100% success rate

# Health Check Configuration
health_check:
  enabled: true
  port: 8080 # HTTP port for health check endpoints
  check_interval_seconds: 60 # How often to check component health

  # Alert thresholds
  alert_thresholds:
    reconciliation_daemon_down_minutes: 5 # Alert if daemon down for 5+ min
    orchestrator_timeout_minutes: 60 # Alert if orchestrator runs > 1 hour
    task_queue_stale_hours: 24 # Alert if task queue not updated in 24h
    error_rate_threshold: 0.1 # Alert if error rate > 10%

# Retry Configuration
max_retries: 3 # Retry failed operations
retry_delay_seconds: 60 # Wait between retries
exponential_backoff: true # Use exponential backoff for retries

# Alert Configuration
alerts:
  enabled: true # Alerts enabled for production
  channels:
    email:
      enabled: true
      sns_topic_arn: "arn:aws:sns:us-east-1:575734508327:nba-simulator-adce-alerts"
      subject_prefix: "[ADCE Alert]"
    slack:
      enabled: false
      webhook_url: ""
      channel: "#nba-data-alerts"

  # Alert conditions
  alert_on:
    - reconciliation_daemon_stopped
    - orchestrator_timeout
    - high_error_rate
    - critical_tasks_stale

# Scheduled Tasks (Daily automated scraping)
scheduled_tasks:
  enabled: true # Enable scheduled task execution

  # ESPN Daily Scraper (Phase 0.0001)
  daily_espn_scrape:
    enabled: true
    schedule: "0 2 * * *" # Run at 2 AM daily (cron format)
    script: "scripts/etl/espn_incremental_simple.py"
    args: ["--days", "3"] # Scrape last 3 days (catches any missed games)
    priority: HIGH
    timeout_minutes: 60
    retry_on_failure: true
    max_retries: 3
    description: "Daily ESPN data collection for last 3 days"
    post_execution:
      trigger_dims_update: true
      trigger_reconciliation: true
      metric_category: espn_data

  # hoopR Daily Comprehensive (ALL 152 endpoints)
  daily_hoopr_comprehensive:
    enabled: true
    schedule: "0 3 * * *" # Run at 3 AM daily (after ESPN)
    script: "scripts/autonomous/run_scheduled_hoopr_comprehensive.sh"
    args: ["--recent-seasons", "1", "--upload-to-s3"] # Current season only for daily
    priority: HIGH
    timeout_minutes: 180 # 3 hours for single season comprehensive
    retry_on_failure: true
    max_retries: 3
    description: "Daily comprehensive hoopR collection - ALL 152 endpoints (Phases 1-4)"
    post_execution:
      trigger_dims_update: true
      trigger_reconciliation: true
      metric_category: hoopr_comprehensive

  # Basketball Reference Daily Comprehensive (ALL 43 data types)
  daily_bbref_comprehensive:
    enabled: true
    schedule: "0 4 * * *" # Run at 4 AM daily (after ESPN and hoopR)
    script: "scripts/autonomous/run_scheduled_bbref_comprehensive.sh"
    args: ["--priority", "IMMEDIATE", "--season", "current"] # Tier 1-2 daily
    priority: HIGH
    timeout_minutes: 240 # 4 hours for comprehensive (rate limited)
    retry_on_failure: true
    max_retries: 3
    description: "Daily comprehensive Basketball Reference - ALL 43 data types (Tiers 1-11)"
    post_execution:
      trigger_dims_update: true
      trigger_reconciliation: true
      metric_category: basketball_reference_comprehensive

# Logging Configuration
logging:
  level: INFO # DEBUG, INFO, WARNING, ERROR
  file: logs/autonomous_loop.log
  max_size_mb: 100
  backup_count: 5
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# Resource Limits
resource_limits:
  max_memory_mb: 2048 # Kill if memory usage exceeds 2GB
  max_cpu_percent: 80 # Warning if CPU usage exceeds 80%
  disk_space_threshold_gb: 10 # Warning if free disk space < 10GB

# Performance Targets
performance:
  reconciliation_max_minutes: 10 # Target: reconciliation < 10 min
  orchestrator_max_minutes: 60 # Target: orchestration < 1 hour
  task_completion_rate_target: 0.95 # Target: 95% task success rate

# Integration Configuration
integration:
  dims:
    enabled: true
    update_on_cycle_complete: true
    metrics_to_track:
      - cycles_completed
      - tasks_executed
      - orchestrator_success_rate
      - error_count

  scraper_config:
    file: config/scraper_config.yaml

  reconciliation_config:
    file: config/reconciliation_config.yaml

# Maintenance Windows
maintenance:
  enabled: false
  windows: [] # Future: Define maintenance windows when system should pause
  # Example:
  # - day: Sunday
  #   start_time: "02:00"
  #   end_time: "04:00"
  #   timezone: "America/Chicago"

# Dry Run Mode
dry_run:
  enabled: false # If true, simulate operations without executing

# Metadata
metadata:
  phase: "Phase 4 - Autonomous Loop"
  description: "24/7 self-healing data collection system"
  documentation: "docs/AUTONOMOUS_OPERATION.md"
  status: "production"
